<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAPP Brainstem</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #0d1117;
    color: #e6edf3;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 16px 24px;
    border-bottom: 1px solid #21262d;
    display: flex;
    align-items: center;
    gap: 10px;
    background: #161b22;
  }
  header .logo { font-size: 20px; }
  header h1 { font-size: 16px; font-weight: 600; color: #e6edf3; }
  header .status {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #8b949e;
  }
  .dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #3fb950;
    animation: pulse 2s infinite;
  }
  .dot.offline { background: #f85149; animation: none; }
  .dot.pending { background: #d29922; animation: pulse 1s infinite; }
  @keyframes pulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.4; }
  }

  /* Login overlay */
  #login-overlay {
    position: fixed;
    inset: 0;
    background: rgba(13,17,23,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .login-card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    max-width: 420px;
  }
  .login-card h2 { font-size: 20px; margin-bottom: 8px; }
  .login-card p { color: #8b949e; font-size: 14px; margin-bottom: 24px; }
  .login-btn {
    background: #238636;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .login-btn:hover { background: #2ea043; }
  .login-btn:disabled { opacity: 0.5; cursor: default; }
  .device-code {
    font-family: "SF Mono", monospace;
    font-size: 32px;
    font-weight: 700;
    letter-spacing: 4px;
    color: #58a6ff;
    margin: 16px 0;
  }
  .login-status { color: #8b949e; font-size: 13px; margin-top: 16px; }
  .login-success { color: #3fb950; }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .msg {
    display: flex;
    gap: 12px;
    max-width: 760px;
  }
  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg.system { align-self: center; }

  .avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; flex-shrink: 0;
    background: #21262d;
  }
  .msg.user .avatar { background: #1f6feb; }

  .bubble {
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.6;
    max-width: 640px;
    word-break: break-word;
  }
  .msg.assistant .bubble {
    background: #161b22;
    border: 1px solid #21262d;
    border-radius: 4px 12px 12px 12px;
  }
  .msg.assistant .bubble a { color: #58a6ff; text-decoration: none; }
  .msg.assistant .bubble a:hover { text-decoration: underline; }
  .msg.assistant .bubble strong { color: #e6edf3; }
  .msg.assistant .bubble ol, .msg.assistant .bubble ul {
    padding-left: 20px; margin: 8px 0;
  }
  .msg.assistant .bubble li { margin: 6px 0; }
  .msg.assistant .bubble p { margin: 6px 0; }
  .msg.assistant .bubble p:first-child { margin-top: 0; }
  .msg.assistant .bubble p:last-child { margin-bottom: 0; }
  .msg.assistant .bubble code {
    background: #0d1117; padding: 2px 6px; border-radius: 4px;
    font-family: "SF Mono", monospace; font-size: 12px;
  }
  .msg.assistant .bubble pre {
    background: #0d1117; padding: 10px; border-radius: 6px;
    overflow-x: auto; margin: 8px 0;
  }
  .msg.assistant .bubble pre code { padding: 0; background: none; }
  .msg.user .bubble {
    background: #1f6feb;
    border-radius: 12px 4px 12px 12px;
    white-space: pre-wrap;
  }
  .msg.system .bubble {
    background: transparent;
    color: #8b949e;
    font-size: 12px;
    border: none;
    padding: 4px 8px;
  }

  .agent-logs {
    margin-top: 8px;
    padding: 8px 12px;
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: 6px;
    font-size: 11px;
    color: #8b949e;
    font-family: "SF Mono", monospace;
    white-space: pre-wrap;
  }
  .logs-label {
    font-size: 10px;
    color: #3fb950;
    font-family: "SF Mono", monospace;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .typing {
    display: flex; gap: 4px; align-items: center; padding: 4px 0;
  }
  .typing span {
    width: 6px; height: 6px; border-radius: 50%;
    background: #8b949e;
    animation: bounce 1.2s infinite;
  }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  footer {
    padding: 16px 24px;
    border-top: 1px solid #21262d;
    background: #161b22;
  }
  .input-row {
    display: flex;
    gap: 10px;
    max-width: 760px;
    margin: 0 auto;
  }
  #input {
    flex: 1;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 8px;
    color: #e6edf3;
    font-size: 14px;
    padding: 10px 14px;
    resize: none;
    outline: none;
    line-height: 1.5;
    max-height: 120px;
    transition: border-color 0.15s;
  }
  #input:focus { border-color: #1f6feb; }
  #input::placeholder { color: #484f58; }

  #send {
    background: #1f6feb;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, opacity 0.15s;
    align-self: flex-end;
  }
  #send:hover { background: #388bfd; }
  #send:disabled { opacity: 0.4; cursor: default; }

  .meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 760px;
    margin: 0 auto 8px;
    font-size: 11px;
    color: #484f58;
  }
  #session-id { font-family: "SF Mono", monospace; }
  #clear-btn {
    background: none; border: none; color: #484f58;
    cursor: pointer; font-size: 11px; text-decoration: underline;
  }
  #clear-btn:hover { color: #8b949e; }

  /* Model selector */
  #model-select {
    background: #0d1117;
    color: #e6edf3;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
    font-family: "SF Mono", monospace;
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
  }
  #model-select:hover { border-color: #58a6ff; }
  #model-select:focus { border-color: #1f6feb; }

  /* Sources panel */
  #sources-toggle {
    background: none; border: 1px solid #30363d; color: #8b949e;
    border-radius: 6px; padding: 4px 10px; font-size: 12px; cursor: pointer;
    margin-left: 8px; transition: all 0.15s;
  }
  #sources-toggle:hover { border-color: #58a6ff; color: #e6edf3; }
  #sources-panel {
    display: none;
    position: fixed; right: 0; top: 52px; bottom: 0; width: 340px;
    background: #161b22; border-left: 1px solid #21262d;
    z-index: 50; overflow-y: auto; padding: 16px;
    box-shadow: -4px 0 16px rgba(0,0,0,0.3);
  }
  #sources-panel.open { display: block; }
  #sources-panel h3 { font-size: 14px; margin-bottom: 12px; color: #e6edf3; }
  .repo-input-row {
    display: flex; gap: 6px; margin-bottom: 16px;
  }
  .repo-input-row input {
    flex: 1; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #e6edf3; font-size: 12px; padding: 6px 10px;
    outline: none;
  }
  .repo-input-row input:focus { border-color: #1f6feb; }
  .repo-input-row button {
    background: #238636; color: #fff; border: none; border-radius: 6px;
    padding: 6px 12px; font-size: 12px; cursor: pointer; font-weight: 600;
    white-space: nowrap;
  }
  .repo-input-row button:hover { background: #2ea043; }
  .repo-card {
    background: #0d1117; border: 1px solid #21262d; border-radius: 8px;
    margin-bottom: 12px; overflow: hidden;
  }
  .repo-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 12px; border-bottom: 1px solid #21262d;
  }
  .repo-name {
    font-size: 13px; font-weight: 600; color: #58a6ff;
    font-family: "SF Mono", monospace;
  }
  .repo-disconnect {
    background: none; border: none; color: #f85149; font-size: 11px;
    cursor: pointer; text-decoration: underline;
  }
  .agent-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; border-bottom: 1px solid #161b22;
    font-size: 12px;
  }
  .agent-item:last-child { border-bottom: none; }
  .agent-item-name { color: #e6edf3; }
  .agent-item-desc { color: #8b949e; font-size: 11px; margin-top: 2px; }
  .agent-toggle {
    position: relative; width: 36px; height: 20px;
    background: #21262d; border-radius: 10px; cursor: pointer;
    border: none; flex-shrink: 0;
    transition: background 0.2s;
  }
  .agent-toggle.on { background: #238636; }
  .agent-toggle::after {
    content: ''; position: absolute; top: 2px; left: 2px;
    width: 16px; height: 16px; border-radius: 50%;
    background: #fff; transition: transform 0.2s;
  }
  .agent-toggle.on::after { transform: translateX(16px); }
  .no-repos { color: #484f58; font-size: 12px; text-align: center; padding: 24px 0; }
</style>
</head>
<body>

<div id="login-overlay" style="display:none">
  <div class="login-card">
    <div style="font-size:48px;margin-bottom:16px">ðŸ§ </div>
    <h2>RAPP Brainstem</h2>
    <p>Sign in with your GitHub account to use Copilot AI.</p>
    <div id="login-step1">
      <button class="login-btn" onclick="startLogin()">Sign in with GitHub</button>
    </div>
    <div id="login-step2" style="display:none">
      <p style="margin-bottom:8px">Enter this code on GitHub:</p>
      <div class="device-code" id="device-code"></div>
      <a id="verify-link" href="#" target="_blank" style="color:#58a6ff;font-size:14px">Open GitHub â†’</a>
      <div class="login-status" id="login-status">Waiting for authorization...</div>
    </div>
    <div id="login-step3" style="display:none">
      <div style="font-size:48px;margin-bottom:16px">âœ…</div>
      <p class="login-success" style="font-size:16px;font-weight:600">Connected to GitHub Copilot!</p>
    </div>
  </div>
</div>

<header>
  <span class="logo">ðŸ§ </span>
  <h1>RAPP Brainstem</h1>
  <div class="status">
    <div class="dot" id="dot"></div>
    <span id="status-text">checking...</span>
    <select id="model-select" onchange="changeModel(this.value)"></select>
    <button id="sources-toggle" onclick="toggleSources()">âš¡ Sources</button>
  </div>
</header>

<div id="sources-panel">
  <h3>âš¡ Agent Sources</h3>
  <div class="repo-input-row">
    <input id="repo-url" placeholder="github.com/owner/repo" />
    <button onclick="connectRepo()">Connect</button>
  </div>
  <div id="repos-list">
    <div class="no-repos">No repos connected. Paste a GitHub URL above.</div>
  </div>
</div>

<div id="chat">
  <div class="msg system">
    <div class="bubble">Connected to localhost:7071 â€” type a message to begin</div>
  </div>
</div>

<footer>
  <div class="meta-row">
    <span>Session: <span id="session-id">â€”</span></span>
    <button id="clear-btn" onclick="clearChat()">Clear</button>
  </div>
  <div class="input-row">
    <textarea id="input" rows="1" placeholder="Message brainstem..." autocomplete="off"></textarea>
    <button id="send" onclick="sendMessage()">Send</button>
  </div>
</footer>

<script>
  const API = '';  // same origin
  let sessionId = null;
  let history = [];

  // Health check â€” also handles login state
  async function checkHealth() {
    try {
      const r = await fetch(`${API}/health`);
      const d = await r.json();
      if (d.status === 'ok') {
        document.getElementById('dot').className = 'dot';
        document.getElementById('status-text').textContent = d.copilot ? 'copilot âœ“' : 'online';
        document.getElementById('login-overlay').style.display = 'none';
        loadModels();
      } else {
        // Not authenticated
        document.getElementById('dot').className = 'dot offline';
        document.getElementById('status-text').textContent = 'not signed in';
        document.getElementById('login-overlay').style.display = 'flex';
      }
    } catch {
      document.getElementById('dot').className = 'dot offline';
      document.getElementById('status-text').textContent = 'offline';
    }
  }
  checkHealth();
  setInterval(checkHealth, 10000);

  // Device code login
  async function startLogin() {
    try {
      document.querySelector('.login-btn').disabled = true;
      const r = await fetch(`${API}/login`, { method: 'POST' });
      const d = await r.json();
      if (d.error) { alert(d.error); return; }

      document.getElementById('login-step1').style.display = 'none';
      document.getElementById('login-step2').style.display = 'block';
      document.getElementById('device-code').textContent = d.user_code;
      document.getElementById('verify-link').href = d.verification_uri;
      
      // Open GitHub in new tab
      window.open(d.verification_uri, '_blank');
      
      // Poll for completion
      pollLogin();
    } catch (e) {
      alert('Failed to start login: ' + e.message);
      document.querySelector('.login-btn').disabled = false;
    }
  }

  async function pollLogin() {
    try {
      const r = await fetch(`${API}/login/poll`, { method: 'POST' });
      const d = await r.json();
      if (d.error) {
        document.getElementById('login-status').textContent = d.error;
        return;
      }
      if (d.status === 'ok') {
        document.getElementById('login-step2').style.display = 'none';
        document.getElementById('login-step3').style.display = 'block';
        setTimeout(() => {
          document.getElementById('login-overlay').style.display = 'none';
          checkHealth();
        }, 1500);
        return;
      }
      // Still pending â€” poll again
      setTimeout(pollLogin, 5000);
    } catch {
      setTimeout(pollLogin, 5000);
    }
  }

  // Model selector
  let modelsLoaded = false;
  async function loadModels() {
    if (modelsLoaded) return;
    try {
      const r = await fetch(`${API}/models`);
      const d = await r.json();
      const sel = document.getElementById('model-select');
      sel.innerHTML = '';
      (d.models || []).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        if (m.id === d.current) opt.selected = true;
        sel.appendChild(opt);
      });
      modelsLoaded = true;
    } catch {}
  }

  async function changeModel(modelId) {
    try {
      const r = await fetch(`${API}/models/set`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: modelId })
      });
      const d = await r.json();
      if (d.error) alert(d.error);
      else appendMsg('system', `Model switched to ${modelId}`);
    } catch (e) {
      alert('Failed to switch model: ' + e.message);
    }
  }

  // â”€â”€ Sources panel â”€â”€
  function toggleSources() {
    const panel = document.getElementById('sources-panel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) loadRepos();
  }

  async function loadRepos() {
    try {
      const r = await fetch(`${API}/repos`);
      const d = await r.json();
      const list = document.getElementById('repos-list');
      if (!d.repos || d.repos.length === 0) {
        list.innerHTML = '<div class="no-repos">No repos connected. Paste a GitHub URL above.</div>';
        return;
      }
      list.innerHTML = d.repos.map(repo => `
        <div class="repo-card">
          <div class="repo-header">
            <span class="repo-name">${repo.repo}</span>
            <button class="repo-disconnect" onclick="disconnectRepo('${repo.url}')">remove</button>
          </div>
          ${repo.agents.map(a => `
            <div class="agent-item">
              <div>
                <div class="agent-item-name">${a.name}</div>
                ${a.description ? `<div class="agent-item-desc">${a.description}</div>` : ''}
              </div>
              <button class="agent-toggle ${a.enabled ? 'on' : ''}"
                onclick="toggleAgent(this, '${repo.url}', '${a.id}', ${!a.enabled})"></button>
            </div>
          `).join('')}
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to load repos:', e);
    }
  }

  async function connectRepo() {
    const input = document.getElementById('repo-url');
    const url = input.value.trim();
    if (!url) return;
    input.disabled = true;
    try {
      const r = await fetch(`${API}/repos/connect`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const d = await r.json();
      if (d.error) { alert(d.error); return; }
      input.value = '';
      appendMsg('system', `Connected to ${d.repo} â€” ${d.agents.length} agent(s) available`);
      loadRepos();
    } catch (e) {
      alert('Failed to connect: ' + e.message);
    } finally {
      input.disabled = false;
    }
  }

  async function disconnectRepo(url) {
    await fetch(`${API}/repos/disconnect`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    appendMsg('system', `Disconnected ${url}`);
    loadRepos();
  }

  async function toggleAgent(btn, repoUrl, agentId, enable) {
    btn.disabled = true;
    try {
      const r = await fetch(`${API}/repos/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: repoUrl, agent_id: agentId, enable })
      });
      const d = await r.json();
      if (d.error) { alert(d.error); return; }
      btn.classList.toggle('on', enable);
      appendMsg('system', `Agent ${agentId} ${enable ? 'enabled' : 'disabled'}`);
    } catch (e) {
      alert('Toggle failed: ' + e.message);
    } finally {
      btn.disabled = false;
    }
  }

  // Enter key in repo input
  document.getElementById('repo-url')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') connectRepo();
  });

  // Auto-resize textarea
  const input = document.getElementById('input');
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  function appendMsg(role, text, logs) {
    const chat = document.getElementById('chat');
    const wrap = document.createElement('div');
    wrap.className = `msg ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? 'ðŸ‘¤' : 'ðŸ§ ';

    const right = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    if (role === 'assistant' && typeof marked !== 'undefined') {
      bubble.innerHTML = marked.parse(text);
      bubble.querySelectorAll('a').forEach(a => a.target = '_blank');
    } else {
      bubble.textContent = text;
    }
    right.appendChild(bubble);

    if (logs) {
      const label = document.createElement('div');
      label.className = 'logs-label';
      label.textContent = 'âš¡ agent logs';
      const logBox = document.createElement('div');
      logBox.className = 'agent-logs';
      logBox.textContent = logs;
      right.appendChild(label);
      right.appendChild(logBox);
    }

    wrap.appendChild(avatar);
    wrap.appendChild(right);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return wrap;
  }

  function appendTyping() {
    const chat = document.getElementById('chat');
    const wrap = document.createElement('div');
    wrap.className = 'msg assistant';
    wrap.id = 'typing-indicator';
    wrap.innerHTML = `
      <div class="avatar">ðŸ§ </div>
      <div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>
    `;
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  function removeTyping() {
    document.getElementById('typing-indicator')?.remove();
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    input.style.height = 'auto';
    document.getElementById('send').disabled = true;

    appendMsg('user', text);
    history.push({ role: 'user', content: text });

    appendTyping();

    try {
      const body = { user_input: text, conversation_history: history };
      if (sessionId) body.session_id = sessionId;

      const r = await fetch(`${API}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const d = await r.json();
      removeTyping();

      if (d.error) {
        appendMsg('system', `Error: ${d.error}`);
      } else {
        sessionId = d.session_id;
        document.getElementById('session-id').textContent = sessionId?.slice(0, 8) + '...';
        history.push({ role: 'assistant', content: d.response });
        appendMsg('assistant', d.response, d.agent_logs || null);
      }
    } catch (err) {
      removeTyping();
      appendMsg('system', `Could not reach brainstem: ${err.message}`);
    }

    document.getElementById('send').disabled = false;
    input.focus();
  }

  function clearChat() {
    history = [];
    sessionId = null;
    document.getElementById('session-id').textContent = 'â€”';
    const chat = document.getElementById('chat');
    chat.innerHTML = `<div class="msg system"><div class="bubble">Chat cleared â€” start a new conversation</div></div>`;
  }
</script>
</body>
</html>
